---
import Bars from "./Bars.astro"
import svgUnderline from '../assets/underline.svg'
import arrowCard from '../assets/arrow-card.svg'
import robotSurvivor from '../assets/RobotSurvivor.png';
import goblinmancer from '../assets/Goblinmancer.PNG';
import growing from '../assets/GrowingFear.png';
import castellnovo from '../assets/castellnovoRecortado.jpg';
import leftalone from '../assets/LeftAloneLogo.jpg';
import img127iq from '../assets/127_IQ.png';
import deltaTime from '../assets/DeltaTimeitch.png';
import paper from '../assets/papercover.PNG';

const getYouTubeId = (url) => {
  if (!url) return null;
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  return (match && match[2].length === 11) ? match[2] : null;
};

const portfolio = [
  { 
    name: 'Delta Time', 
    desc: `Open-World Action RPG - Solo dev`,
    cover: deltaTime.src,
    itch: 'https://vicmelia.itch.io/delta-time',
    youtube: 'https://youtu.be/jzMR-CSynDc'
  },
  { 
    name: 'Robot Survivor', 
    desc: `Horde Survival - Solo dev`,
    cover: robotSurvivor.src,
    itch: 'https://vicmelia.itch.io/robot-survivor',
    youtube: 'https://youtu.be/RkS8gFprMt0'
  },
  { 
    name: 'Cronicas de Castellnovo', 
    desc: `Educational Point & Click - Team Project`,
    cover: castellnovo.src,
    itch: 'https://vicmelia.itch.io/cronicas-de-castellnovo',
    youtube: 'https://www.youtube.com/watch?v=QYuvL1p8N3o'
  },
  { 
    name: 'Goblinmancer', 
    desc: `RTS - Game Jam - BackToBits Studio`,
    cover: goblinmancer.src,
    itch: 'https://kiskidiego.itch.io/goblinmancer',
  },
  { 
    name: 'Growing Fear', 
    desc: `Farming - Game Jam - BackToBits Studio`,
    cover: growing.src,
    itch: 'https://hollowblink.itch.io/growing-fear',
  },
  { 
    name: 'Paper Shooter', 
    desc: `Arcade - Solo Dev`,
    cover: paper.src,
    itch: 'https://vicmelia.itch.io/paper-shooter',
    youtube: 'https://www.youtube.com/watch?v=tQzyVg-6hKo'
  },
  { 
    name: 'Lefting Alone', 
    desc: `Survival - Game Jam - Team Project`,
    cover: leftalone.src,
    itch: 'https://vicmelia.itch.io/lefting-alone',
    youtube: 'https://www.youtube.com/watch?v=evTjKs0ekJI'
  },
  { 
    name: '127 IQ', 
    desc: `Platformer - Solo dev`,
    cover: img127iq.src,
    youtube: 'https://www.youtube.com/watch?v=c6DXEmj3P7A'
  },
]
---

<section class="py-25 space-y-10 px-5" id="work">
  <div class="max-w-md mx-auto relative">
    <h1 class="text-4xl font-medium text-center">Video Game Portfolio</h1>
    <img src={svgUnderline.src} alt="arrow" width="140" class="absolute left-50 -bottom-1" />
  </div>

  <div class="max-w-3xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-10">
    {portfolio.map(item => {
      const videoId = getYouTubeId(item.youtube);

      return (
      <article class="flex flex-col bg-white p-5 group relative transition-all duration-200 hover:shadow-[8px_8px_0px_rgba(0,0,0,0.2)] border border-gray-100">
        
        <div 
            class="w-full h-[200px] overflow-hidden border-2 border-black relative game-card-media bg-black"
            data-video-id={videoId}
        >
          <img
            src={item.cover}
            alt={item.name}
            class="w-full h-full object-cover transition duration-300 relative z-10"
          />

          <div class="video-container absolute inset-0 w-full h-full z-20 hidden"></div>
        </div>

        <div class="space-y-1 pt-4 flex-1">
          <div class="flex pr-2 items-center">
            <h2 class="text-xl font-bold flex-1">{item.name}</h2>
            <img src={arrowCard.src} alt="arrow" width="25" class="group-hover:translate-x-1 transition-transform" />
          </div>
          <p class="text-gray-600 text-sm leading-relaxed">{item.desc}</p>
        </div>

        <div class="mt-5 flex gap-3">
            {item.itch && (
              <a
                href={item.itch}
                target="_blank"
                rel="noreferrer"
                class="flex-1 py-2 px-3 bg-[#fa5c5c] text-white font-bold text-xs uppercase tracking-wide text-center border-2 border-transparent hover:border-black hover:bg-white hover:text-[#fa5c5c] transition-colors rounded shadow-sm"
              >
                Itch.io
              </a>
            )}

            {item.youtube && (
              <a
                href={item.youtube}
                target="_blank"
                rel="noreferrer"
                class="flex-1 py-2 px-3 bg-gray-900 text-white font-bold text-xs uppercase tracking-wide text-center border-2 border-transparent hover:border-black hover:bg-white hover:text-black transition-colors rounded shadow-sm"
              >
                YouTube
              </a>
            )}
        </div>

        <div class="mt-4">
            <Bars />
        </div>
      </article>
    )})}
  </div>
</section>

<script>
  const cards = document.querySelectorAll('.game-card-media');

  cards.forEach(card => {
    const videoId = card.getAttribute('data-video-id');
    if (!videoId) return;

    const videoContainer = card.querySelector('.video-container');
    let timeoutId;

    card.addEventListener('mouseenter', () => {
      timeoutId = setTimeout(() => {
        videoContainer.classList.remove('hidden');
        
        const iframe = document.createElement('iframe');
        iframe.setAttribute('src', `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0&modestbranding=1&loop=1&playlist=${videoId}&showinfo=0&rel=0`);
        iframe.setAttribute('class', 'w-full h-full object-cover pointer-events-none'); 
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
        
        videoContainer.innerHTML = '';
        videoContainer.appendChild(iframe);
      }, 50);
    });

    card.addEventListener('mouseleave', () => {
      clearTimeout(timeoutId);
      videoContainer.classList.add('hidden');
      videoContainer.innerHTML = '';
    });
  });
</script>